<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cafe Master - Ultra Compact</title>
    <meta property="og:title" content="Cafe Master - Ultra Compact">
    <meta property="og:description" content="„Ç≥„É≥„Éë„ÇØ„Éà„Å™„Ç´„Éï„Çß„Ç≤„Éº„É†„ÄÇ„Ç≥„Éº„Éí„Éº„Çí‰Ωú„Å£„Å¶Ê•Ω„Åó„ÇÇ„ÅÜÔºÅ">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://kaguya-game.github.io/cafe-game/">
    <meta property="og:image" content="https://kaguya-game.github.io/cafe-game/cafe-game2.png">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Cafe Master - Ultra Compact">
    <meta name="twitter:description" content="„Ç≥„É≥„Éë„ÇØ„Éà„Å™„Ç´„Éï„Çß„Ç≤„Éº„É†„ÄÇ„Ç≥„Éº„Éí„Éº„Çí‰Ωú„Å£„Å¶Ê•Ω„Åó„ÇÇ„ÅÜÔºÅ">
    <meta name="twitter:image" content="https://kaguya-game.github.io/cafe-game/cafe-game2.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&family=Quicksand:wght@500;700&display=swap');
        
        :root {
            --color-bg: #f7f3ef;
            --color-dark: #4a3f35;
            --color-tray: #556b2f; 
        }

        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-dark);
            touch-action: manipulation;
            overflow: hidden;
            height: 100vh;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #game-container {
            position: relative;
            max-width: 400px;
            width: 100%;
            height: 100%;
            max-height: 800px;
            background: white;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* „Éà„É¨„Éº„Ç®„É™„Ç¢ */
        .wood-tray {
            background: var(--color-tray);
            border: 3px solid #3e4d22;
            border-radius: 20px;
            padding: 8px;
            position: relative;
            flex: 0 0 auto;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 4px;
        }

        .serving-area {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 12px;
            width: 100%;
            height: 85px; 
            margin-bottom: 6px;
        }

        .cup-container {
            position: relative;
            width: 50px; 
            height: 60px;
        }

        .cup-handle {
            position: absolute;
            right: -9px;
            top: 14px;
            width: 14px;
            height: 22px;
            border: 3px solid #ffffff;
            border-radius: 6px;
            z-index: 1;
        }

        .cup-body {
            position: relative;
            width: 100%;
            height: 100%;
            border: 3px solid #ffffff;
            border-radius: 5px 5px 18px 18px;
            overflow: hidden;
            background: rgba(255,255,255,0.4);
            backdrop-filter: blur(2px);
            z-index: 2;
            display: flex;
            flex-direction: column-reverse;
        }

        .plate-container {
            position: relative;
            width: 80px; 
            height: 20px;
            background: #ffffff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e0e0e0;
        }

        .food-on-plate {
            position: absolute;
            bottom: 12px; 
            display: flex;
            flex-direction: column-reverse;
            align-items: center;
            width: 100%;
        }

        .liquid-layer {
            width: 100%;
            height: 25%;
            transition: all 0.2s ease;
        }

        .color-coffee { background-color: #4a2c2a !important; }
        .color-milk { background-color: #fcf9f2 !important; }
        .color-tea { background-color: #b35a4d !important; }
        .color-sugar { background-color: rgba(255,255,255,0.8) !important; }
        .color-ice { background-color: rgba(200, 230, 255, 0.5) !important; }
        .color-lemon { background-color: #f4d35e !important; }

        .btn-ingredient, .btn-food {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 2px 0 #e5e7eb;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2px;
            height: 52px;
        }
        .btn-ingredient:active, .btn-food:active {
            transform: translateY(2px);
            box-shadow: 0 0 0 #e5e7eb;
        }

        .customer-bubble {
            background: #ffffff;
            border-radius: 12px;
            position: relative;
            box-shadow: 0 1px 6px rgba(0,0,0,0.03);
        }
    </style>
</head>
<body>

    <div id="game-container" class="border-[4px] border-[#4a3f35]">
        
        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
        <div class="bg-[#4a3f35] text-white p-2 px-3 flex justify-between items-center shrink-0">
            <div class="flex flex-col">
                <span class="text-[8px] text-[#a89685] font-bold">Â£≤‰∏ä</span>
                <span id="score" class="text-base font-bold">0</span>
            </div>
            <div class="flex items-center space-x-2">
                <div class="bg-[#5d5146] px-3 py-0.5 rounded-lg">
                    <span id="timer" class="text-base font-bold text-[#f4d35e]">60</span>
                </div>
                <button id="pause-btn" onclick="togglePause()" class="bg-[#5d5146] hover:bg-[#6b5f53] text-white px-2 py-0.5 rounded-md text-[11px]">‰∏ÄÊôÇÂÅúÊ≠¢</button>
            </div>
            <div class="flex flex-col items-end">
                <span id="rank" class="text-[9px] font-bold text-[#a89685]">Ë¶ãÁøí„ÅÑ</span>
                <div class="flex items-center space-x-1">
                    <span class="text-[7px] text-[#a89685]">„Éí„É≥„Éà</span>
                    <input type="checkbox" id="training-mode" onchange="toggleTraining()" class="w-2.5 h-2.5 accent-[#8ba88e]">
                </div>
                <div class="flex items-center space-x-1 mt-1">
                    <span class="text-[7px] text-[#a89685]">Èü≥</span>
                    <input type="checkbox" id="sound-toggle" checked onchange="toggleSound()" class="w-3 h-3 accent-[#f4d35e]">
                </div>
            </div>
        </div>

        <!-- „É°„Ç§„É≥ -->
        <div class="flex-1 flex flex-col p-2 bg-[#f7f3ef] overflow-hidden">
            
            <!-- „ÅäÂÆ¢„Åï„Çì -->
            <div class="flex items-center space-x-2 mb-2 shrink-0">
                <div id="customer-container" class="w-9 h-9 bg-[#e9dcc9] rounded-full flex items-center justify-center text-lg border border-white">
                    üë§
                </div>
                <div class="customer-bubble flex-1 p-2 border border-[#e5e1da]">
                    <p id="order-text" class="font-bold text-[#4a3f35] text-[11px] leading-tight">„ÅÑ„Çâ„Å£„Åó„ÇÉ„ÅÑ„Åæ„Åõ„ÄÇ</p>
                    <div id="hint-area" class="hidden mt-1 border-t border-dashed border-[#e5e1da]">
                        <div id="hint-icons" class="flex gap-1 opacity-60"></div>
                    </div>
                </div>
            </div>

            <!-- „Éà„É¨„ÉºÔºàÊúÄÂ∞è„ÉªÊìç‰Ωú„Ç®„É™„Ç¢„Å∏ËøëÊé•Ôºâ -->
            <div class="wood-tray">
                <div id="toast" class="absolute top-0.5 px-3 py-0.5 rounded-full bg-[#4a3f35] text-white text-[8px] opacity-0 transition-all duration-300 z-50">
                    Message
                </div>

                <div class="serving-area">
                    <div id="cup-wrapper" class="cup-container cup-type-hot">
                        <div class="cup-handle"></div>
                        <div id="cup-contents" class="cup-body"></div>
                    </div>
                    <div class="plate-container">
                        <div id="plate-contents" class="food-on-plate"></div>
                    </div>
                </div>

                <div class="flex space-x-3 items-center w-full justify-center">
                    <button onclick="serveDrink()" class="bg-[#8ba88e] text-white px-6 py-2 rounded-full font-bold shadow-md active:scale-95 text-[11px] uppercase border-b-2 border-[#6d8570]">
                        Êèê‰æõ
                    </button>
                    <p id="current-recipe" class="text-[8px] text-white/70 font-bold uppercase w-16 text-center truncate">Á©∫</p>
                    <button onclick="trashDrink()" class="bg-[#d9b99b] text-white px-4 py-2 rounded-full font-bold shadow-md active:scale-95 text-[11px] uppercase border-b-2 border-[#b89a7e]">
                        Ê∂àÂéª
                    </button>
                </div>
            </div>

            <!-- Êìç‰Ωú„Éë„Éç„É´Ôºà„Éà„É¨„Éº„ÅÆ„Åô„Åê‰∏ã„Å´ÈÖçÁΩÆÔºâ -->
            <div class="shrink-0 space-y-1.5 mt-1">
                <div class="grid grid-cols-3 gap-1">
                    <button onclick="addIngredient('coffee')" class="btn-ingredient">
                        <span class="text-base">‚òï</span><span class="text-[8px] font-bold text-[#8b7e74]">„Ç≥„Éº„Éí„Éº</span>
                    </button>
                    <button onclick="addIngredient('milk')" class="btn-ingredient">
                        <span class="text-base">ü•õ</span><span class="text-[8px] font-bold text-[#8b7e74]">„Éü„É´„ÇØ</span>
                    </button>
                    <button onclick="addIngredient('tea')" class="btn-ingredient">
                        <span class="text-base">üçÇ</span><span class="text-[8px] font-bold text-[#8b7e74]">Á¥ÖËå∂</span>
                    </button>
                    <button onclick="addIngredient('ice')" class="btn-ingredient">
                        <span class="text-base">üßä</span><span class="text-[8px] font-bold text-[#8b7e74]">Ê∞∑</span>
                    </button>
                    <button onclick="addIngredient('sugar')" class="btn-ingredient">
                        <span class="text-base">üç¨</span><span class="text-[8px] font-bold text-[#8b7e74]">Á†ÇÁ≥ñ</span>
                    </button>
                    <button onclick="addIngredient('lemon')" class="btn-ingredient">
                        <span class="text-base">üçã</span><span class="text-[8px] font-bold text-[#8b7e74]">„É¨„É¢„É≥</span>
                    </button>
                </div>
                
                <div class="grid grid-cols-4 gap-1 border-t border-[#e5e1da] pt-1.5">
                    <button onclick="addIngredient('cake')" class="btn-food">
                        <span class="text-base">üç∞</span><span class="text-[8px] font-bold text-[#a65d50]">„Ç±„Éº„Ç≠</span>
                    </button>
                    <button onclick="addIngredient('sandwich')" class="btn-food">
                        <span class="text-base">ü•™</span><span class="text-[8px] font-bold text-[#a65d50]">„Çµ„É≥„Éâ</span>
                    </button>
                    <button onclick="addIngredient('donut')" class="btn-food">
                        <span class="text-base">üç©</span><span class="text-[8px] font-bold text-[#a65d50]">„Éâ„Éº„Éä„ÉÑ</span>
                    </button>
                    <button onclick="addIngredient('pancake')" class="btn-food">
                        <span class="text-base">ü•û</span><span class="text-[8px] font-bold text-[#a65d50]">„Éë„É≥„Ç±„Éº„Ç≠</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- „Ç™„Éº„Éê„Éº„É¨„Ç§ -->
        <div id="overlay" class="absolute inset-0 bg-[#4a3f35]/95 flex flex-col items-center justify-center p-6 text-center z-50">
            <h1 id="overlay-title" class="text-2xl font-bold text-white mb-2 tracking-widest font-['Quicksand']">CAFE MASTER</h1>
            <p id="overlay-msg" class="text-[#a89685] mb-6 text-[10px]">ÊúÄÈ´ò„ÅÆ‰∏ÄÊùØ„Çí„ÄÅ„ÅÇ„Å™„Åü„Å´„ÄÇ</p>
            <button onclick="startGame()" class="bg-[#8ba88e] text-white text-sm font-bold py-3 px-10 rounded-full shadow-xl tracking-widest transition-all active:scale-95">
                ÈñãÂ∫ó„Åô„Çã
            </button>
        </div>

        <div id="pause-overlay" class="hidden absolute inset-0 bg-[#000000]/50 flex flex-col items-center justify-center p-6 text-center z-50">
            <h2 class="text-2xl font-bold text-white mb-2">‰∏ÄÊôÇÂÅúÊ≠¢‰∏≠</h2>
            <p class="text-[#a89685] mb-4 text-[12px]">„Ç≤„Éº„É†„Çí‰∏ÄÊôÇÂÅúÊ≠¢„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇÁ∂öË°å„Åô„Çã„Å´„ÅØÂÜçÈñã„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
            <button onclick="resumeGame()" class="bg-[#8ba88e] text-white text-sm font-bold py-3 px-8 rounded-full shadow-xl active:scale-95">ÂÜçÈñã</button>
        </div>
    </div>

    <script>
        const menu = [
            { name: "„Ç¢„Ç§„Çπ„Ç≥„Éº„Éí„Éº", ingredients: ["coffee", "ice"], text: "„Ç¢„Ç§„Çπ„Ç≥„Éº„Éí„Éº„Çí‰∏ÄÊùØ„ÄÇ", icons: ["‚òï", "üßä"] },
            { name: "„Ç´„Éï„Çß„É©„ÉÜ", ingredients: ["coffee", "milk"], text: "„Ç´„Éï„Çß„É©„ÉÜ„ÄÅ„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô„ÄÇ", icons: ["‚òï", "ü•õ"] },
            { name: "„Éü„É´„ÇØ„ÉÜ„Ç£„Éº", ingredients: ["tea", "milk"], text: "Ê∏©„Åã„ÅÑ„Éü„É´„ÇØ„ÉÜ„Ç£„Éº„Çí„ÄÇ", icons: ["üçÇ", "ü•õ"] },
            { name: "„É¨„É¢„É≥„ÉÜ„Ç£„Éº", ingredients: ["tea", "lemon"], text: "„É¨„É¢„É≥„ÉÜ„Ç£„Éº„Å´„Åó„Çà„ÅÜ„Åã„Å™„ÄÇ", icons: ["üçÇ", "üçã"] },
            { name: "„Çµ„É≥„Éâ„Ç§„ÉÉ„ÉÅ", ingredients: ["sandwich"], text: "„Çµ„É≥„Éâ„Ç§„ÉÉ„ÉÅ„Çí„ÅÑ„Åü„Å†„Åë„Åæ„Åô„ÅãÔºü", icons: ["ü•™"] },
            { name: "„Ç∑„Éß„Éº„Éà„Ç±„Éº„Ç≠", ingredients: ["cake"], text: "„Ç∑„Éß„Éº„Éà„Ç±„Éº„Ç≠„ÄÅ‰∏Ä„Å§„Åè„Å†„Åï„ÅÑ„ÄÇ", icons: ["üç∞"] },
            { name: "„Ç±„Éº„Ç≠„Çª„ÉÉ„Éà", ingredients: ["coffee", "cake"], text: "„Ç≥„Éº„Éí„Éº„Å®„Ç±„Éº„Ç≠„ÅÆ„Çª„ÉÉ„Éà„Çí„ÄÇ", icons: ["‚òï", "üç∞"] },
            { name: "„Éâ„Éº„Éä„ÉÑ„Çª„ÉÉ„Éà", ingredients: ["coffee", "milk", "ice", "donut"], text: "„Ç¢„Ç§„Çπ„É©„ÉÜ„Å®„Éâ„Éº„Éä„ÉÑ„ÅÆ„Çª„ÉÉ„Éà„Åß„ÄÇ", icons: ["‚òï", "ü•õ", "üßä", "üç©"] },
            { name: "„ÉÜ„Ç£„Éº„Çø„Ç§„É†„Çª„ÉÉ„Éà", ingredients: ["tea", "cake", "sandwich"], text: "Á¥ÖËå∂„Å®„Ç±„Éº„Ç≠„ÄÅ„Çµ„É≥„Éâ„Ç§„ÉÉ„ÉÅ„Çí„ÄÇ", icons: ["üçÇ", "üç∞", "ü•™"] },
            { name: "„Éë„É≥„Ç±„Éº„Ç≠„Çª„ÉÉ„Éà", ingredients: ["coffee", "milk", "sugar", "pancake"], text: "Áîò„ÅÑ„É©„ÉÜ„Å®„Éë„É≥„Ç±„Éº„Ç≠„Çí„ÄÇ", icons: ["‚òï", "ü•õ", "üç¨", "ü•û"] }
        ];

        const ingredientData = {
            coffee: { label: "Coffee", color: "color-coffee", type: "liquid", emoji: "‚òï" },
            milk: { label: "Milk", color: "color-milk", type: "liquid", emoji: "ü•õ" },
            tea: { label: "Tea", color: "color-tea", type: "liquid", emoji: "üçÇ" },
            sugar: { label: "Sugar", color: "color-sugar", type: "liquid", emoji: "üç¨" },
            ice: { label: "Ice", color: "color-ice", type: "liquid", emoji: "üßä" },
            lemon: { label: "Lemon", color: "color-lemon", type: "liquid", emoji: "üçã" },
            cake: { label: "Cake", color: "food", type: "food", emoji: "üç∞" },
            sandwich: { label: "Sandwich", color: "food", type: "food", emoji: "ü•™" },
            donut: { label: "Donut", color: "food", type: "food", emoji: "üç©" },
            pancake: { label: "Pancake", color: "food", type: "food", emoji: "ü•û" }
        };

        const stylishCustomers = ["üé®", "üëí", "üíº", "üì∏", "üñãÔ∏è", "üö≤", "üåø", "üêà", "üéª"];

        // --- Sound synthesizer (WebAudio) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const masterGain = audioCtx.createGain();
        masterGain.gain.value = 0.15;
        masterGain.connect(audioCtx.destination);
        let soundEnabled = true;

        // BGM nodes
        let bgmGain = null;
        let bgmOscillators = [];
        let bgmPlaying = false;

        function resumeAudio() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playTone(freq, type = 'sine', duration = 0.08, volume = 0.12, decay = 0.02, filter) {
            if (!soundEnabled) return;
            resumeAudio();
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.type = type;
            o.frequency.value = freq;
            g.gain.value = volume;
            if (filter) {
                filter.connect(g);
                o.connect(filter);
            } else {
                o.connect(g);
            }
            g.connect(masterGain);
            const now = audioCtx.currentTime;
            g.gain.setValueAtTime(volume, now);
            g.gain.exponentialRampToValueAtTime(0.0001, now + duration + decay);
            o.start(now);
            o.stop(now + duration + decay + 0.01);
        }

        // Generic tones
        function playClick() { playTone(880, 'square', 0.04, 0.06); }
        function playSuccess() { playTone(660, 'sawtooth', 0.12, 0.12); setTimeout(() => playTone(990, 'sine', 0.08, 0.09), 120); }
        function playFail() { playTone(220, 'sawtooth', 0.16, 0.16); }
        function playTrash() { playTone(160, 'sine', 0.12, 0.12); setTimeout(() => playTone(120, 'sine', 0.08, 0.1), 80); }
        function playStart() { playTone(880, 'sine', 0.12, 0.14); setTimeout(() => playTone(1320, 'sine', 0.12, 0.14), 150); }

        // Pouring sound for liquids (coffee/tea/milk)
        function playPour() {
            if (!soundEnabled) return;
            resumeAudio();
            const now = audioCtx.currentTime;
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            const filt = audioCtx.createBiquadFilter();
            filt.type = 'lowpass';
            filt.frequency.setValueAtTime(1500, now);
            o.type = 'sine';
            o.frequency.setValueAtTime(900, now);
            o.frequency.exponentialRampToValueAtTime(220, now + 0.28);
            g.gain.setValueAtTime(0.12, now);
            g.gain.exponentialRampToValueAtTime(0.0001, now + 0.35);
            o.connect(filt);
            filt.connect(g);
            g.connect(masterGain);
            o.start(now);
            o.stop(now + 0.36);
        }

        // Ice clink ‚Äî short metallic ticks
        function playIceClink() {
            if (!soundEnabled) return;
            resumeAudio();
            const now = audioCtx.currentTime;
            const makeBlip = (freq, t) => {
                const o = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                o.type = 'triangle';
                o.frequency.value = freq;
                g.gain.value = 0.08;
                o.connect(g);
                g.connect(masterGain);
                g.gain.setValueAtTime(0.08, now + t);
                g.gain.exponentialRampToValueAtTime(0.0001, now + t + 0.08);
                o.start(now + t);
                o.stop(now + t + 0.09);
            };
            makeBlip(2500, 0);
            makeBlip(1800, 0.05);
        }

        // Lemon zing ‚Äî bright, short upper-frequency slice
        function playLemonZing() {
            if (!soundEnabled) return;
            resumeAudio();
            const now = audioCtx.currentTime;
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            const bp = audioCtx.createBiquadFilter();
            bp.type = 'highpass';
            bp.frequency.value = 800;
            o.type = 'sine';
            o.frequency.setValueAtTime(1400, now);
            g.gain.setValueAtTime(0.09, now);
            g.gain.exponentialRampToValueAtTime(0.0001, now + 0.12);
            o.connect(bp);
            bp.connect(g);
            g.connect(masterGain);
            o.start(now);
            o.stop(now + 0.13);
        }

        // Sugar sprinkle ‚Äî small soft arpeggio
        function playSugarSprinkle() {
            if (!soundEnabled) return;
            resumeAudio();
            const now = audioCtx.currentTime;
            const freqs = [1200, 1500, 1800];
            freqs.forEach((f, i) => {
                const o = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                o.type = 'triangle';
                o.frequency.value = f;
                g.gain.value = 0.05;
                o.connect(g);
                g.connect(masterGain);
                g.gain.setValueAtTime(0.05, now + i * 0.04);
                g.gain.exponentialRampToValueAtTime(0.0001, now + i * 0.04 + 0.08);
                o.start(now + i * 0.04);
                o.stop(now + i * 0.04 + 0.09);
            });
        }

        function playSoundForIngredient(type) {
            if (!soundEnabled) return;
            if (type === 'coffee' || type === 'tea' || type === 'milk') {
                playPour();
            } else if (type === 'ice') {
                playIceClink();
            } else if (type === 'lemon') {
                playLemonZing();
            } else if (type === 'sugar') {
                playSugarSprinkle();
            } else {
                playClick();
            }
        }

        function toggleSound() {
            soundEnabled = document.getElementById('sound-toggle').checked;
            masterGain.gain.value = soundEnabled ? 0.15 : 0;
            if (bgmGain) bgmGain.gain.value = soundEnabled ? 0.3 : 0;
        }

        // Cafe-style BGM generator (ambient loop)
        function startBGM() {
            if (bgmPlaying || !soundEnabled) return;
            console.log('Starting BGM');
            resumeAudio();
            bgmGain = audioCtx.createGain();
            bgmGain.gain.value = 0.2; // Adjusted volume
            bgmGain.connect(masterGain);

            // Cafe jazz chord progression: C6 - A7 - Dm7 - G7
            const chords = [
                [261.63, 329.63, 392.00, 440.00], // C6
                [220.00, 277.18, 329.63, 392.00], // A7
                [293.66, 349.23, 440.00, 523.25], // Dm7
                [196.00, 246.94, 293.66, 349.23]  // G7
            ];

            let chordIndex = 0;
            const changeChord = () => {
                console.log('Changing chord to', chordIndex);
                // Stop previous oscillators
                bgmOscillators.forEach(o => o.stop());
                bgmOscillators = [];

                const chord = chords[chordIndex];
                chord.forEach((freq, i) => {
                    const o = audioCtx.createOscillator();
                    const g = audioCtx.createGain();
                    const filt = audioCtx.createBiquadFilter();
                    filt.type = 'lowpass';
                    filt.frequency.value = 1000;
                    o.type = 'triangle';
                    o.frequency.value = freq;
                    g.gain.value = 0.08;
                    o.connect(filt);
                    filt.connect(g);
                    g.connect(bgmGain);
                    o.start();
                    bgmOscillators.push(o);
                });

                // Add bass note
                const baseFreq = chord[0] / 2;
                const oBase = audioCtx.createOscillator();
                const gBase = audioCtx.createGain();
                oBase.type = 'sawtooth';
                oBase.frequency.value = baseFreq;
                gBase.gain.value = 0.05;
                oBase.connect(gBase);
                gBase.connect(bgmGain);
                oBase.start();
                bgmOscillators.push(oBase);

                chordIndex = (chordIndex + 1) % chords.length;
                setTimeout(changeChord, 5000); // Change every 5 seconds
            };

            changeChord();
            bgmPlaying = true;
        }

        function stopBGM() {
            if (!bgmPlaying) return;
            bgmOscillators.forEach(o => o.stop());
            bgmOscillators = [];
            bgmGain = null;
            bgmPlaying = false;
        }


        let score = 0;
        let timeLeft = 60;
        let gameActive = false;
        let paused = false;
        let currentOrder = null;
        let currentCup = [];
        let timerId = null;
        let trainingMode = false;

        const scoreEl = document.getElementById('score');
        const timerEl = document.getElementById('timer');
        const overlay = document.getElementById('overlay');
        const orderTextEl = document.getElementById('order-text');
        const cupContentsEl = document.getElementById('cup-contents');
        const plateContentsEl = document.getElementById('plate-contents');
        const cupWrapper = document.getElementById('cup-wrapper');
        const currentRecipeEl = document.getElementById('current-recipe');
        const customerContainer = document.getElementById('customer-container');
        const hintArea = document.getElementById('hint-area');
        const hintIcons = document.getElementById('hint-icons');

        function startGame() {
            score = 0;
            timeLeft = 60;
            gameActive = true;
            paused = false;
            scoreEl.innerText = score;
            timerEl.innerText = timeLeft;
            overlay.classList.add('hidden');
            document.getElementById('pause-btn').innerText = '‰∏ÄÊôÇÂÅúÊ≠¢';
            resumeAudio();
            playStart();
            startBGM();
            newOrder();
            startTimer();
        }

        function startTimer() {
            if (timerId) clearInterval(timerId);
            timerId = setInterval(() => {
                if (!paused) {
                    timeLeft--;
                    timerEl.innerText = timeLeft;
                    if (timeLeft <= 0) endGame();
                }
            }, 1000);
        }

        // Pause / Resume controls
        function togglePause() {
            if (!gameActive) return;
            if (paused) resumeGame(); else pauseGame();
        }

        function pauseGame() {
            if (!gameActive || paused) return;
            paused = true;
            if (timerId) clearInterval(timerId);
            stopBGM();
            document.getElementById('pause-overlay').classList.remove('hidden');
            document.getElementById('pause-btn').innerText = 'ÂÜçÈñã';
        }

        function resumeGame() {
            if (!gameActive || !paused) return;
            paused = false;
            document.getElementById('pause-overlay').classList.add('hidden');
            document.getElementById('pause-btn').innerText = '‰∏ÄÊôÇÂÅúÊ≠¢';
            startBGM();
            startTimer();
        }

        function endGame() {
            gameActive = false;
            clearInterval(timerId);
            stopBGM();
            overlay.classList.remove('hidden');
            document.getElementById('overlay-title').innerText = "CLOSED";
            let rank = getRank(score);
            document.getElementById('overlay-msg').innerHTML = `
                Â£≤‰∏ä: <span class="text-white font-bold">${score}ÂÜÜ</span><br>
                ${rank}
            `;
            document.querySelector('#overlay button').innerText = "„ÇÇ„ÅÜ‰∏ÄÂ∫¶";
        }

        function newOrder() {
            currentOrder = menu[Math.floor(Math.random() * menu.length)];
            customerContainer.innerText = stylishCustomers[Math.floor(Math.random() * stylishCustomers.length)];
            orderTextEl.innerText = currentOrder.text;
            hintIcons.innerHTML = currentOrder.icons.map(icon => 
                `<span class="bg-[#f7f3ef] border border-[#e5e1da] rounded px-1 py-0.5 text-[8px]">${icon}</span>`
            ).join('');
            trashDrink();
        }

        function toggleTraining() {
            trainingMode = document.getElementById('training-mode').checked;
            hintArea.classList.toggle('hidden', !trainingMode);
        }

        function addIngredient(type) {
            if (!gameActive || paused || currentCup.length >= 6) return;
            currentCup.push(type);
            playSoundForIngredient(type);
            updateUI();
        }

        function updateUI() {
            cupContentsEl.innerHTML = '';
            plateContentsEl.innerHTML = '';
            
            const isIce = currentCup.includes('ice');
            cupWrapper.className = `cup-container ${isIce ? 'cup-type-ice' : 'cup-type-hot'}`;

            currentCup.forEach(ing => {
                const data = ingredientData[ing];
                if (data.type === "food") {
                    const item = document.createElement('div');
                    item.className = "text-3xl drop-shadow-sm mb-[-6px]";
                    item.innerText = data.emoji;
                    plateContentsEl.appendChild(item);
                } else {
                    const item = document.createElement('div');
                    item.className = `liquid-layer ${data.color}`;
                    if (ing === 'ice') item.innerHTML = `<div class="flex justify-center text-[7px] opacity-20 mt-0.5">üßä</div>`;
                    cupContentsEl.appendChild(item);
                }
            });

            currentRecipeEl.innerText = currentCup.length === 0 ? "Á©∫" : currentCup.map(ing => ingredientData[ing].label).join('+');
        }

        function serveDrink() {
            if (!gameActive || paused || currentCup.length === 0) return;
            const isCorrect = checkOrder();
            if (isCorrect) {
                const points = currentOrder.ingredients.length >= 3 ? 300 : 150;
                score += points;
                playSuccess();
                showToast("Ôºã" + points);
                newOrder();
            } else {
                playFail();
                showToast("„Éü„ÇπÔºÅ");
                score = Math.max(0, score - 50);
                trashDrink();
            }
            scoreEl.innerText = score;
            document.getElementById('rank').innerText = getRank(score);
        }

        function checkOrder() {
            if (currentCup.length !== currentOrder.ingredients.length) return false;
            return [...currentCup].sort().every((val, index) => val === [...currentOrder.ingredients].sort()[index]);
        }

        function trashDrink() {
            if (paused || !gameActive) return;
            currentCup = [];
            playTrash();
            updateUI();
        }

        function getRank(s) {
            if (s >= 3000) return "‰ºùË™¨„ÅÆ„Éû„Çπ„Çø„Éº";
            if (s >= 1500) return "„Éô„ÉÜ„É©„É≥Â∫óÂì°";
            if (s >= 800) return "‰∏Ä‰∫∫Ââç";
            return "Ë¶ãÁøí„ÅÑ";
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.style.opacity = '1';
            toast.style.transform = 'translateY(-3px)';
            setTimeout(() => { 
                toast.style.opacity = '0'; 
                toast.style.transform = 'translateY(0)';
            }, 800);
        }
    </script>
</body>
</html>